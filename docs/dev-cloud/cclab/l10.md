# AWS Virtual Private Cloud (VPC)

## 1. Introduction to VPC

An AWS Virtual Private Cloud (VPC) is a logically isolated section of the AWS Cloud. It's where you can launch your AWS resources (like EC2 instances or databases) into a virtual network that you define.

It's a virtual network dedicated to your AWS account. This gives you complete control over the networking environment, including your own IP address ranges, subnets, route tables, and network gateways—similar to having your own private data center inside AWS.

### 1.1. Default VPC vs. Custom VPC

|**Feature**|**Default VPC**|**Custom VPC**|
|---|---|---|
|**Best For**|Beginners, quick testing, learning environments, or temporary setups.|Production environments, enterprise setups, or multi-tier architectures.|
|**Creation**|Created automatically by AWS in each region.|Created manually by the user.|
|**Ready to Use**|Yes, you can launch EC2 instances immediately—no setup needed.|Requires manual configuration of subnets, gateways, and route tables.|
|**CIDR Block**|Always uses `172.31.0.0/16`.|User-defined IP range (e.g., `10.0.0.0/16`).|
|**Subnets**|One default public subnet in each Availability Zone.|User-defined subnets (public or private).|
|**Internet Connectivity**|Pre-configured with an Internet Gateway.|Requires manual creation and attachment of an Internet Gateway.|
|**Route Table**|Automatically configured to provide internet access.|Must be created and configured manually.|
|**Security**|Comes with default Security Groups and Network ACLs.|Requires manual creation of custom Security Groups and NACLs.|

## 2. Core Components of a VPC

| **Component**              | **Description**                                                                                                                                                                                                                                                                                                                                |
| -------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **CIDR Block (IP Range)**  | The overall range of IP addresses for your VPC (e.g., `10.0.0.0/16`).                                                                                                                                                                                                                                                                          |
| **Subnets**                | Smaller divisions inside your VPC, each tied to one Availability Zone.<br><br>* **Public Subnet:** Has a route to an Internet Gateway; for web servers.<br><br>* **Private Subnet:** No direct internet access; for databases or internal apps.<br><br>CIDR example: `Public: 10.0.1.0/24`, `Private: 10.0.2.0/24`<br>                         |
| **Internet Gateway (IGW)** | A gateway that connects your VPC to the Internet. It's required for resources in a public subnet to receive internet traffic and must be attached to the VPC.<br><br>Supports bi-directional communication.                                                                                                                                    |
| **NAT Gateway**            | Enables instances in a private subnet to connect _out_ to the internet (e.g., for software updates) without being exposed to _inbound_ traffic. <br><br>It is deployed inside a public subnet and requires an Elastic IP.<br><br>Traffic is only one-way: Private -> Internet                                                                  |
| **Route Tables**           | A set of rules (routes) that determine where network traffic is directed. Each subnet must be associated with one route table.<br><br>* **Public Route:** `0.0.0.0/0` $\rightarrow$ Internet Gateway.  <br><br>* **Private Route:** `0.0.0.0/0` $\rightarrow$ NAT Gateway.<br><br>Ensures separation b/w public and private network.           |
| **Security Groups (SG)**   | An instance-level firewall controlling inbound and outbound traffic.<br><br>* **Stateful:** If inbound traffic is allowed, the corresponding outbound (return) traffic is automatically allowed.<br><br>* **Example:** A `WebServer-SG` allows HTTP (80) and SSH (22), while a `Database-SG` allows MySQL (3306) only from the `WebServer-SG`. |
| **Network ACLs (NACL)**    | A subnet-level firewall that acts as an additional layer of security.<br><br>* **Stateless:** Inbound and outbound rules must be defined separately.  <br><br>* The default NACL allows all traffic.<br><br>Used for fine-grained control or compliance environment.                                                                           |
| **EC2 Instances**          | VM inside subnets,<br><br> Public subnet -> hosts Web Server (Apache), with public IP<br> Private subnet -> hosts Database Server (MySQL), with private IP<br><br> Controlled by their security groups and route tables.<br>                                                                                                                   |
| **Elastic IP (EIP)**       | A static, public IPv4 address. It's used for NAT Gateways or servers that need a fixed public IP, as it remains constant even if an instance is stopped.<br><br>Useful for NAT gateways, Load balancers or fixed server access.                                                                                                                |
| **VPC Peering**            | Connects two VPCs so they can communicate privately as if they are on the same network.                                                                                                                                                                                                                                                        |

> [!NOTE] Developer's Note: 
> A common point of confusion is **Security Groups (SG) vs. Network ACLs (NACL)**.
> 
> - Think of an **SG** as a **firewall for your instance**. It's stateful.
>     
> - Think of a **NACL** as a **firewall for your subnet** (like a checkpoint at the border of a neighborhood). It's stateless.
>     
> - For 99% of use cases, you'll get the fine-grained control you need from **Security Groups**. Most people leave the default "allow all" NACL as-is.
>     

## 3. Practical Guide: Building a Two-Tier VPC Architecture

This guide provides a step-by-step process for designing and configuring a VPC for a two-tier web application.

**Objective:**

- Create one **Public Subnet** for web servers (using an **Internet Gateway**).
    
- Create one **Private Subnet** for databases (using a **NAT Gateway**).
    
- Configure separate **Route Tables** for each subnet.
    
- Implement custom **Security Groups** to enforce network isolation.
    

### Step 1: Create a New VPC

1. Navigate to the **VPC Dashboard** in the AWS Management Console.
    
2. Click **Create VPC**.
    
3. Select the **VPC only** option.
    
4. Enter the following details:
    
    - **Name tag**: `MyWebAppVPC`
        
    - **IPv4 CIDR block**: `10.0.0.0/16`
        
    - **Tenancy**: `Default`
        
5. Click **Create VPC**.
    
> [!NOTE] Developer's Note:
>  Building "virtual data center." The `10.0.0.0/16` CIDR block is a standard choice from the private IP range. It gives you 65,536 total IP addresses to use within this VPC. This is your "plot of land".


### Step 2: Create Subnets

#### a) Public Subnet

1. Go to **Subnets** and click **Create subnet**.
    
2. Select the VPC you created: `MyWebAppVPC`.
    
3. Enter the following details:
    
    - **Subnet name**: `PublicSubnet`
        
    - **Availability Zone**: Choose one (e.g., `ap-south-1a`).
        
    - **IPv4 CIDR block**: `10.0.1.0/24`
        
4. Click **Create subnet**.
    

#### b) Private Subnet

1. Click **Create subnet** again.
    
2. Select the same VPC: `MyWebAppVPC`.
    
3. Enter the following details:
    
    - **Subnet name**: `PrivateSubnet`
        
    - **Availability Zone**: Choose a different one for high availability (e.g., `ap-south-1b`).
        
    - **IPv4 CIDR block**: `10.0.2.0/24`
        
4. Click **Create subnet**.
    
> [!NOTE] Developer's Note :
> Dividing "land" into "lots."
> 
> - **`.../24`**: This gives each subnet 256 IPs (a good, standard size).
>     
> - **`10.0.1.0` vs `10.0.2.0`**: The CIDR blocks cannot overlap. They are two distinct, separate ranges _inside_ your main `10.0.0.0/16` block.
>     
> - **Different AZs**: This is a key best practice for high availability. If the entire `ap-south-1a` data center fails, your `PrivateSubnet` (and the database in it) in `ap-south-1b` will still be online.
>     

### Step 3: Create and Attach an Internet Gateway (IGW)

1. Go to **Internet Gateways** and click **Create Internet Gateway**.
    
2. Enter a **Name tag**: `MyWebApp-IGW`.
    
3. Click **Create Internet Gateway**.
    
4. Select the newly created IGW, click **Actions**, and choose **Attach to VPC**.
    
5. Select `MyWebAppVPC` and click **Attach Internet Gateway**.

Now IGW is linked to VPC and the public subnet can reach the internet.

> [!NOTE] Developer's Note: 
> The IGW is the "front door" to the internet for your _entire_ VPC. By default, your VPC is isolated. Attaching an IGW doesn't automatically give everything internet access; it just makes that "door" available to be used. A route table is still needed to tell subnets _how_ to use it.

### Step 4: Create a NAT Gateway

1. Go to **NAT Gateways** and click **Create NAT Gateway**.
    
2. Enter the following details:
    
    - **Name**: `MyWebApp-NATGW`
        
    - **Subnet**: `PublicSubnet` (NAT Gateways live in a public subnet).
        
    - **Elastic IP Allocation ID**: Click **Allocate new Elastic IP**.
        
3. Click **Create NAT Gateway**.
    
This allows instances in private subnet to access the internet (for updates) without being exposed/reachable from outside.

_Note: NAT Gateways are a paid resource_.
	
> [!NOTE] Developer's Note:
>  This is the "secure exit" for your private resources.
> 
> - **Why in Public Subnet?** A NAT Gateway's _job_ is to talk to the internet. To do that, it _must_ have a route to the IGW, which means it must be placed in a subnet that we've designated as "public".
>     
> - **Why an Elastic IP?** The NAT Gateway is a managed AWS service. If it fails, AWS provisions a new one for you. By using an Elastic (static) IP, the public IP address for your outbound traffic _never changes_, even if the underlying hardware fails. This is critical for whitelisting your IP with third-party APIs.
>     

### Step 5: Configure Route Tables

#### a) Public Route Table for IGW

1. Go to **Route Tables** and click **Create route table**.
    
2. Enter the following details:
    
    - **Name**: `PublicRT`
        
    - **VPC**: `MyWebAppVPC`
        
3. Click **Create route table**.
    
4. Select `PublicRT`, go to the **Routes** tab, and click **Edit routes**.
    
5. Click **Add route**, and enter:
    
    - **Destination**: `0.0.0.0/0`
        
    - **Target**: `Internet Gateway` $\rightarrow$ `MyWebApp-IGW`
        
6. Save the routes.
    
7. Go to the **Subnet associations** tab, click **Edit subnet associations**, select `PublicSubnet`, and click **Save associations**.
    
Now PublicSubnet has internet access.

#### b) Private Route Table for IGW

1. Create another route table:
    
    - **Name**: `PrivateRT`
        
    - **VPC**: `MyWebAppVPC`
        
2. Select `PrivateRT`, go to the **Routes** tab, and click **Edit routes**.
    
3. Click **Add route**, and enter:
    
    - **Destination**: `0.0.0.0/0`
        
    - **Target**: `NAT Gateway` $\rightarrow$ `MyWebApp-NATGW`
        
4. Save the routes.
    
5. Go to the **Subnet associations** tab, click **Edit subnet associations**, select `PrivateSubnet`, and click **Save associations**.
    

> **Note:** Each subnet can be associated with only one route table. If a subnet isn't explicitly associated, it automatically uses the **Main Route Table**.


> [!NOTE] Developer's Note
> 
> This is the most important concept. Route Tables are the "GPS" for your subnets.
> 
> - **Destination `0.0.0.0/0`**: This is a catch-all that literally means "any IP address that isn't already known."
>     
> - **Public RT**: You're telling the `PublicSubnet`: "If traffic is going anywhere I don't recognize (`0.0.0.0/0`), send it to the **Internet Gateway**." This allows _two-way_ traffic.
>     
> - **Private RT**: You're telling the `PrivateSubnet`: "If traffic is going anywhere I don't recognize (`0.0.0.0/0`), send it to the **NAT Gateway**." This allows _one-way_ (outbound) traffic, but nothing from the internet can initiate a connection back in.
>     

### Step 6: Create Security Groups

#### a) WebServer Security Group

1. Go to **Security Groups** and click **Create security group**.
    
2. Enter the following details:
    
    - **Security group name**: `WebServer-SG`
        
    - **Description**: `Allow HTTP, HTTPS, SSH`
        
    - **VPC**: `MyWebAppVPC`
        
3. Add the following Inbound rules:

| **Type** | **Protocol** | **Port Range** | **Source** |
| -------- | ------------ | -------------- | ---------- |
| SSH      | TCP          | 22             | My IP      |
| HTTP     | TCP          | 80             | 0.0.0.0/0  |
| HTTPS    | TCP          | 443            | 0.0.0.0/0  |

	    
4. Click **Create security group**.
    

#### b) Database Security Group

1. Create another security group:
    
    - **Security group name**: `Database-SG`
        
    - **Description**: `Allow MySQL/Aurora from WebServer-SG`
        
    - **VPC**: `MyWebAppVPC`
        
2. Add the following Inbound rule (this enforces least-privilege).    

| **Type**     | **Protocol** | **Port Range** | **Source**                               |
| ------------ | ------------ | -------------- | ---------------------------------------- |
| MySQL/Aurora | TCP          | 3306           | `WebServer-SG` (Select the WebServer-SG) |
 
3. Click **Create security group**.
    
> [!NOTE] Developer's Note: 
> This is a critical security best practice.
> 
> - **Stateful**: Security Groups are stateful. You only need to define _inbound_ rules. If you allow port 80 in, the return traffic is automatically allowed out.
>     
> - **Source `WebServer-SG`**: You are **not** hard-coding the IP address of your web server. Instead, you're telling the `Database-SG` to "only accept traffic on port 3306 from _any instance that has the `WebServer-SG` attached to it_." This is far more flexible and secure. If your web server's IP changes, this rule still works.
>     

### Step 7: Launch EC2 Instances

#### a) Web Server in Public Subnet

1. Go to **EC2** and click **Launch Instance**.
    
2. Choose an AMI (e.g., Amazon Linux 2).
    
3. In **Network settings**, select:
    
    - **VPC**: `MyWebAppVPC`
        
    - **Subnet**: `PublicSubnet`
        
    - **Auto-assign Public IP**: **Enable**
        
    - **Firewall (security groups)**: `Select existing security group` $\rightarrow$ `WebServer-SG`
        
4. Launch the instance.

This can be Windows instance, Accessed through RDP client and from this instance login to the DB server.

#### b) Database Server in Private Subnet

1. Launch another EC2 instance.
    
2. In **Network settings**, select:
    
    - **VPC**: `MyWebAppVPC`
        
    - **Subnet**: `PrivateSubnet`
        
    - **Auto-assign Public IP**: **Disable**
        
    - **Firewall (security groups)**: `Select existing security group` $\rightarrow$ `Database-SG`
        
3. Launch the instance.

The DBInstance is fully isolated and cannot be accessed directly from the internet.

    
> [!NOTE] Developer's Note
> 
> - **Public Instance**: "Enable" gives your instance a _temporary, dynamic_ public IP so you can SSH into it from the internet. It's in a public subnet, so this is expected.
>     
> - **Private Instance**: "Disable" is a critical security step. This instance should **not** have a public IP. It should only be reachable via its private IP from _within_ the VPC (e.g., from your web server).
>     

### Step 8: Testing and Verification

1. **Connect to Web Server:** Connect via SSH using its public IP address (e.g., `ssh -i key.pem ec2-user@<public-ip>`).
    
2. **Test Web Server Internet:** From the Web Server, try to install a package (e.g., `sudo yum update -y`). This **should succeed** because it's in the public subnet with a route to the IGW.
    
3. **Test Internal Connectivity:** From the Web Server, try to ping the **Database Server's private IP** (e.g., `ping <db-private-ip>`). This **should succeed**, as both instances are in the same VPC.
    
4. **Test Private Instance Outbound Access:** From the Database Server (which you'd have to connect to via the Web Server first, using it as a "bastion host"), try to ping an external site. This **should NOT work** if only testing with `ping`, as `ping` (ICMP) may be blocked by default. A better test, like `curl` to an external site or `sudo yum update -y`, _would_ work, proving the NAT Gateway is functioning for TCP traffic.


## Traffic Flow Explained

1. **Route 1 (Public User):** A user $\rightarrow$ IGW $\rightarrow$ PublicRT $\rightarrow$ Web Server.
    
    - A user on the **INTERNET** sends a request.
        
    - It hits the **Internet Gateway (IGW)**.
        
    - The **Public Route Table** (PublicRT) sees the request and knows the **Web Server**'s IP. It forwards the traffic to the **Public Subnet**.
        
    - The `WebServer-SG` allows the port 80/443 traffic in.
        
2. **Route 2 (Internal):** Web Server $\rightarrow$ Database.
    
    - The **Web Server** needs data.
        
    - It makes a request to the **Database**'s _private IP_ (e.g., `10.0.2.50`).
        
    - Because this is all `local` traffic (inside the `10.0.0.0/16` block), it never leaves the VPC. It just goes directly from the public subnet to the private subnet.
        
    - The `Database-SG` allows this traffic because its source is the `WebServer-SG`.
        
3. **Route 3 & 4 (Private Update):** Database $\rightarrow$ PrivateRT $\rightarrow$ NAT Gateway $\rightarrow$ PublicRT $\rightarrow$ IGW $\rightarrow$ Internet.
    
    - The **Database** server needs to download a security patch.
        
    - It sends its request to the **INTERNET** (destination `0.0.0.0/0`).
        
    - The **Private Route Table** (PrivateRT) intercepts this. Its rule says, "All `0.0.0.0/0` traffic goes to the **NAT Gateway**."
        
    - The request goes to the **NAT Gateway** (which lives in the **Public Subnet**).
        
    - The **NAT Gateway**, which has a public IP, sends the request out through the **IGW** to the **INTERNET**.
        
    - The response comes back to the NAT Gateway, which then forwards it to the Database. The internet _never_ initiated the connection, so it remains secure.
        
```
    +-------------------------------------------------------------------------+
    |   INTERNET                                                              |
    +-------+------------------+----------------------------------------------+
            |                  |
   (User HTTP/S Request)  (DB Software Update)
            |                  |
            v                  ^
    +-------+------------------+----------------------------------------------+
    |   AWS VPC: MyWebAppVPC (10.0.0.0/16)                                    |
    |                                                                         |
    |   +--------------------------+     +----------------------------------+ |
    |   | Internet Gateway (IGW)   |     | NAT Gateway (NAT-GW)             | |
    |   | [Attached to VPC]        |     | [Lives in Public Subnet]         | |
    |   +-----------+--------------+     +----------------+-----------------+ |
    |               |                                       ^                 |
    |   +-----------v------------------------------------+  | (Route 4)       |
    |   | Public Route Table (PublicRT)                  |  |                 |
    |   |------------------------------------------------|  |                 |
    |   | Destination | Target                           |  |                 |
    |   | 10.0.0.0/16 | local                            |  |                 |
    |   | 0.0.0.0/0   | IGW  --------------------------> | -+ (Traffic to IGW)|
    |   +------------------------------------------------+                    |
    |               | (Associated)                                            |
    |   +-----------v-------------------------------------------------------+ |
    |   | Public Subnet (10.0.1.0/24)                                       | |
    |   |                                                                   | |
    |   |   +-----------------------+                                       | |
    |   |   | EC2 Web Server        | (Route 1: User -> IGW -> PublicRT -> Web)
    |   |   | [WebServer-SG]        |                                       | |
    |   |   +----------+------------+                                       | |
    |   +--------------|----------------------------------------------------+ |
    |                  | (Route 2: Web -> DB, internal VPC traffic)           |
    |   +--------------v----------------------------------------------------+ |
    |   | Private Subnet (10.0.2.0/24)                                      | |
    |   |                                                                   | |
    |   |   +-----------------------+                                       | |
    |   |   | EC2 Database          |                                       | |
    |   |   | [Database-SG]         |                                       | |
    |   |   +----------^------------+                                       | |
    |   +--------------|----------------------------------------------------+ |
    |                  | (Route 3: DB needs update)                           |
    |   +--------------v---------------------------------------------------+  |
    |   | Private Route Table (PrivateRT)                                  |  |
    |   |------------------------------------------------------------------|  |
    |   | Destination | Target                                             |  |
    |   | 10.0.0.0/16 | local                                              |  |
    |   | 0.0.0.0/0   | NAT-GW  -------------------------------------------+  |
    |   +------------------------------------------------------------------+  |
    |                                                                         |
    +-------------------------------------------------------------------------+
```

